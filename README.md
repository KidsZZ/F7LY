###### OS大赛 - 内核赛道 - F7LY队

-------------------------------------------------------------

# F7ly OS队内核编写文档

`f7ly`队的os是基于xn6修改而来, 适配loongarch和riscv两种架构的芯片

## 环境依赖
- Ubuntu24.04
- riscv64-linux-gnu-* 系列编译器
- loongarch-linux-gnu-* 系列编译器
- QEMU 9.2.1 for riscv64 and loongarch64

## 运行架构选择
- `F7ly`队的os支持**riscv64**和**loongarch64**两种架构, 默认编译支持**riscv64**架构的内核, 可以通过在使用**make**工具时添加`ARCH=LOONGARCH`或者直接添加`l`的方式指定编译**loongarch64**架构

## 运行方式
- `make build` 在根目录下构建 kernel-qemu
- `make run` 使用kernel-qemu以及外部提供的sdcard.img启动操作系统
- `make clean` 清空构建文件

## 调试方式
- `make debug` 启动qemu调试工具, 再另一个窗口执行`gdb-multiarch -x debug_riscv.gdb`启动**riscv**调试, 或使用`loongarch64-linux-gnu-gdb -x debug_loongarch.gdb`启动**loongarch**调试

## 目录结构
- **docs** 中存放说明文档

- **kernel** 中存放内核的源文件

- **user** 中存放用户的源文件

- **sdcard** 用于文件系统挂载，里面暂时放置了初赛的文件映像  


## 代码模块

**kernel** 目录中对代码进行了模块化分区，支持双架构设计

- **boot** 系统启动模块 - 负责内核的启动流程，包含RISC-V和LoongArch两种架构的启动代码，实现从bootloader到内核main函数的跳转，初始化基础硬件环境

- **devs** 设备管理模块 - 实现统一的设备抽象层，包含字符设备、块设备、流设备等抽象类，提供设备管理器进行设备注册和管理，支持UART、控制台、磁盘等硬件设备

- **fs** 文件系统模块 - 实现了VFS（虚拟文件系统）层，支持多种文件系统包括ext4、FAT、ramfs等，提供统一的文件操作接口，包含缓冲区管理、目录项缓存、inode管理等核心组件

- **hal** 硬件抽象层 - 提供跨架构的硬件抽象，封装CPU相关操作和上下文切换，为上层模块提供统一的硬件接口，支持RISC-V和LoongArch双架构

- **libs** 内核库模块 - 提供内核所需的基础库函数，包括字符串操作、打印输出、内存分配器、模板算法、C++运行时支持等，为内核其他模块提供基础服务

- **mem** 内存管理模块 - 实现完整的内存管理体系，包含物理内存管理器（支持伙伴系统算法）、虚拟内存管理器、堆内存管理器、slab分配器等，提供高效的内存分配和回收机制

- **proc** 进程管理模块 - 实现进程创建、调度、同步等核心功能，包含进程管理器、调度器、信号处理、管道通信、锁机制等，支持多进程并发执行

- **sys** 系统调用模块 - 实现系统调用处理机制，提供用户态程序与内核的交互接口，包含系统调用分发、参数传递、权限检查等功能

- **trap** 中断与异常处理模块 - 处理硬件中断、异常和系统调用，实现中断向量表设置、异常处理流程、时钟中断管理等，支持双架构的不同中断机制

- **tm** 时间管理模块 - 提供时间和定时器相关服务，实现定时器管理器、时间接口等，为进程调度和系统调用提供时间基础服务

- **net** 网络模块 - 网络协议栈的基础框架（预留接口）


## 代码模块

- boot 机器启动 [文档](./docs/机器启动.md)

## 相关文档

#### 1. [分工文档](./docs/cooperation.md)
#### 2. [对写在文档中的架构的建议](./doc/advice.md)